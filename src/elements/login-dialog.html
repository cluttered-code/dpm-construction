<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<dom-module id="login-dialog">
    <template>
        <style include="dpm-theme">
            :host {
                text-align: center;
            }
        </style>

        <content>
            <!-- Must contain <firebase-auth provider="email"> tag -->
        </content>

        <paper-dialog id="dialog">
            <h2>Login</h2>
            <div>
                <iron-a11y-keys id="a11yEnter" keys="enter" on-keys-pressed="_submitForm"></iron-a11y-keys>
                <form is="iron-form" id="form" on-iron-form-submit="submit">
                    <gold-email-input name="email" label="Email" value="{{email}}" error-message="enter valid email" auto-validate required autofocus></gold-email-input>
                    <paper-input type="password" name="password" label="Password" value="{{password}}" error-message="required" auto-validate required></paper-input>
                </form>
            </div>
            <div class="buttons">
                <paper-button error dialog-dismiss>Cancel</paper-button>
                <paper-button raised primary on-tap="_submitForm">Login</paper-button>
            </div>
        </paper-dialog>
        
        <paper-toast id="successToast" success></paper-toast>
        <paper-toast id="errorToast" error></paper-toast>
    </template>

    <script>
        Polymer({
            is: 'login-dialog',
            properties: {
                email: {
                    type: String
                },
                password: {
                    type: String
                }
            },
            ready: function() {
                var firebaseAuth = this.queryEffectiveChildren('firebase-auth');
                if (!firebaseAuth) {
                    console.error('<firebase-auth> tag must be nested in this <login-dialog>');
                }
                this.$.a11yEnter.target = this.$.form;
            },
            open: function() {
                this.$.form.reset();
                this.$.dialog.open();
            },
            submit: function() {
                var firebaseAuth = this.queryEffectiveChildren('firebase-auth');
                if(firebaseAuth.provider !== 'email') {
                  console.error("<firebase-auth> provider must be 'email' not '" + firebaseAuth.provider + "'");
                  return;
                }
                firebaseAuth.signInWithEmailAndPassword(this.email, this.password)
                    .then(function(response) {
                        console.log("Logged in as '" + this.email + "'");
                        this.$.dialog.close();
                        this.$.successToast.show("Logged in as '" + this.email + "'");
                    }.bind(this))
                    .catch(function(error) {
                        this.$.errorToast.show("Invaild login credentials");
                    }.bind(this));
            },
            _submitForm: function() {
                if (this.$.form.validate()) {
                    this.submit();
                }
            }
        });
    </script>
</dom-module>
