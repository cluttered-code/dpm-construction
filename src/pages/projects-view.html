<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../elements/project-form-dialog.html">
<link rel="import" href="../elements/project-card.html">

<dom-module id="projects-view">
    <template>
        <style>
            :host {
                display: block;
                text-align: center;
            }

            .project-cards {
                text-align: center;
            }

            paper-fab {
                position: fixed;
                bottom: 30px;
                right: 30px;
            }
        </style>

        <iron-meta-query key="user" value="{{user}}"></iron-meta-query>

        <h1>Projects</h1>

        <firebase-query id="query" path="/projects" data="{{firbaseProjects}}"></firebase-query>
        <app-indexeddb-mirror key="projects" data="{{firbaseProjects}}" persisted-data="{{projects}}"></app-indexeddb-mirror>

        <section class="project-cards">
            <template is="dom-repeat" items="[[projects]]" as="project">
                <project-card project="[[project]]"></project-card>
            </template>
        </section>

        <template is="dom-if" if="[[user]]">
            <paper-fab icon="add" on-tap="_displayProjectFormDialog">Add Project</paper-fab>
            <project-form-dialog id="projectFormDialog"></project-form-dialog>
        </template>
    </template>

    <script>
        Polymer({
            is: 'projects-view',
            ready: function() {
                // TODO: Remove once iron-meta-query actually notifies
                setInterval(function() {
                    this.user = this.$$('iron-meta-query').byKey('user');
                }.bind(this), 1000);
            },
            _displayProjectFormDialog: function() {
                if (this.user) {
                    this.$.projectFormDialog.open();
                }
            }
        });
    </script>
</dom-module>
